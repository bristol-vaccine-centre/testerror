<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="testerror">
<title>Single test error adjustment • testerror</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Single test error adjustment">
<meta property="og:description" content="testerror">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">testerror</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../articles/testerror.html">Get started</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/bayesian-panel-tests.html">Bayesian adjustment of panel test error</a>
    <a class="dropdown-item" href="../articles/beta-distributions.html">Working with Beta distributions</a>
    <a class="dropdown-item" href="../articles/panel-tests.html">Panel test error adjustment</a>
    <a class="dropdown-item" href="../articles/single-test.html">Single test error adjustment</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/bristol-vaccine-centre/testerror/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Single test error adjustment</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/bristol-vaccine-centre/testerror/blob/HEAD/vignettes/single-test.Rmd" class="external-link"><code>vignettes/single-test.Rmd</code></a></small>
      <div class="d-none name"><code>single-test.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org" class="external-link">tidyverse</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; ── <span style="font-weight: bold;">Attaching core tidyverse packages</span> ──────────────────────── tidyverse 2.0.0 ──</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">dplyr    </span> 1.1.2     <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">readr    </span> 2.1.4</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">forcats  </span> 1.0.0     <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">stringr  </span> 1.5.0</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">ggplot2  </span> 3.5.0     <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">tibble   </span> 3.2.1</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">lubridate</span> 1.9.3     <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">tidyr    </span> 1.3.0</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">purrr    </span> 1.0.1     </span></span>
<span><span class="co">#&gt; ── <span style="font-weight: bold;">Conflicts</span> ────────────────────────────────────────── tidyverse_conflicts() ──</span></span>
<span><span class="co">#&gt; <span style="color: #BB0000;">✖</span> <span style="color: #0000BB;">dplyr</span>::<span style="color: #00BB00;">filter()</span> masks <span style="color: #0000BB;">stats</span>::filter()</span></span>
<span><span class="co">#&gt; <span style="color: #BB0000;">✖</span> <span style="color: #0000BB;">dplyr</span>::<span style="color: #00BB00;">lag()</span>    masks <span style="color: #0000BB;">stats</span>::lag()</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Use the conflicted package (<span style="color: #0000BB; font-style: italic;">&lt;http://conflicted.r-lib.org/&gt;</span>) to force all conflicts to become errors</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://bristol-vaccine-centre.github.io/testerror/index.html">testerror</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>mc.cores <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="co"># parallel::detectCores())</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>testerror.debug<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/rstan_options.html" class="external-link">rstan_options</a></span><span class="op">(</span>auto_write <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">here</span><span class="fu">::</span><span class="fu"><a href="https://here.r-lib.org//reference/i_am.html" class="external-link">i_am</a></span><span class="op">(</span><span class="st">"vignettes/testerror.Rmd"</span><span class="op">)</span></span>
<span><span class="co">#&gt; here() starts at /home/vp22681/Dropbox/Git/testerror</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/source.html" class="external-link">source</a></span><span class="op">(</span><span class="fu">here</span><span class="fu">::</span><span class="fu"><a href="https://here.r-lib.org//reference/here.html" class="external-link">here</a></span><span class="op">(</span><span class="st">"vignettes/formatting.R"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Supposing we have a disease with a true prevalence in a population of
10%. We test for its presence using a test with sensitivity 0.8 and
specificity 0.95. How many positive test results do we expect to see in
a sample of 1000 patients?</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">ap</span> <span class="op">=</span> <span class="fu"><a href="../reference/apparent_prevalence.html">apparent_prevalence</a></span><span class="op">(</span>p <span class="op">=</span> <span class="fl">0.1</span>, sens <span class="op">=</span> <span class="fl">0.8</span>, spec <span class="op">=</span> <span class="fl">0.95</span><span class="op">)</span></span>
<span></span>
<span><span class="va">tmp</span> <span class="op">=</span> <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu">stats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="fl">1000</span>, <span class="fl">1000</span>, <span class="va">ap</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">tmp</span>, <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">x</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html" class="external-link">geom_histogram</a></span><span class="op">(</span>binwidth <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_vline</a></span><span class="op">(</span>xintercept<span class="op">=</span><span class="fl">100</span>, colour<span class="op">=</span><span class="st">"red"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_cartesian.html" class="external-link">coord_cartesian</a></span><span class="op">(</span>xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">25</span>,<span class="fl">175</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="single-test_files/figure-html/unnamed-chunk-2-1.png" width="576"></p>
<p>given this setup the test positivity rate will usually be an
overestimate of true prevalence. If instead the specificity is 0.995 the
picture is completely different, and the expected number of positives
will usually be an underestimate:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">ap</span> <span class="op">=</span> <span class="fu"><a href="../reference/apparent_prevalence.html">apparent_prevalence</a></span><span class="op">(</span>p <span class="op">=</span> <span class="fl">0.1</span>, sens <span class="op">=</span> <span class="fl">0.8</span>, spec <span class="op">=</span> <span class="fl">0.995</span><span class="op">)</span></span>
<span></span>
<span><span class="va">tmp</span> <span class="op">=</span> <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu">stats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="fl">1000</span>, <span class="fl">1000</span>, <span class="va">ap</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">tmp</span>, <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">x</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html" class="external-link">geom_histogram</a></span><span class="op">(</span>binwidth <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_vline</a></span><span class="op">(</span>xintercept<span class="op">=</span><span class="fl">100</span>, colour<span class="op">=</span><span class="st">"red"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_cartesian.html" class="external-link">coord_cartesian</a></span><span class="op">(</span>xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">25</span>,<span class="fl">175</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="single-test_files/figure-html/unnamed-chunk-3-1.png" width="576"></p>
<p>A related question is if sensitivity of the test is 0.8 what
specificity is required at 10% prevalence for apparent prevalence to be
an unbiased estimate? I.e. how specific does a test need to be?</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/optimal_performance.html">optimal_performance</a></span><span class="op">(</span>p<span class="op">=</span><span class="fl">0.1</span>, sens<span class="op">=</span><span class="fl">0.8</span><span class="op">)</span></span>
<span><span class="co">#&gt; $p</span></span>
<span><span class="co">#&gt; [1] 0.1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $sens</span></span>
<span><span class="co">#&gt; [1] 0.8</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $spec</span></span>
<span><span class="co">#&gt; [1] 0.9777821</span></span></code></pre></div>
<p>Any specificity lower than this will result in apparent prevalence
being an overestimate due to false positives outweighing false
negatives, and any specificity higher than this will result in apparent
prevalence being an underestimate, due to false negatives outweighing
false positives.</p>
<div class="section level2">
<h2 id="rogan-gladen-adjustment">Rogan-gladen adjustment<a class="anchor" aria-label="anchor" href="#rogan-gladen-adjustment"></a>
</h2>
<p>We can use the rogan-gladen adjustment to estimate the true
prevalence if we know sensitivity and specificity.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/rogan_gladen.html">rogan_gladen</a></span><span class="op">(</span><span class="fl">0.125</span>, <span class="fl">0.8</span>, <span class="fl">0.95</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.1</span></span></code></pre></div>
<p>However this suffers from a truncation issue if the apparent
prevalence is outside of the range of <code>(1-spec)</code> to
<code>sens</code>:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/rogan_gladen.html">rogan_gladen</a></span><span class="op">(</span><span class="fl">0.05</span>, <span class="fl">0.8</span>, <span class="fl">0.95</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0</span></span>
<span><span class="fu"><a href="../reference/rogan_gladen.html">rogan_gladen</a></span><span class="op">(</span><span class="fl">0.8</span>, <span class="fl">0.8</span>, <span class="fl">0.95</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 1</span></span></code></pre></div>
<p>It also requires an exact measure of sensitivity and specificity. In
reality this is very hard to obtain. In the associated paper we discuss
3 methods for accounting for uncertainty in sensitivity and specificity
in estimating true prevalence from apparent prevalence. These are the
lang-reiczigel method, a resampling procedure combined with rogan gladen
estimates and a full bayesian model. To illustrate these we look a the
example of BinaxNOW testing.</p>
</div>
<div class="section level2">
<h2 id="binaxnow-example">BinaxNOW Example<a class="anchor" aria-label="anchor" href="#binaxnow-example"></a>
</h2>
<p>In this case we have uncertain estimates of sensitivity and
specificity from the literature, supplied as median values with 95%
confidence intervals. We assume this has an underlying Beta distribution
to estimate uncertainty.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># Fit beta distributions to sinclair 2013 data:</span></span>
<span><span class="va">sens</span> <span class="op">=</span> <span class="fu"><a href="../reference/beta_params.html">beta_params</a></span><span class="op">(</span>median <span class="op">=</span> <span class="fl">0.740</span>, lower <span class="op">=</span> <span class="fl">0.666</span>, upper <span class="op">=</span> <span class="fl">0.823</span><span class="op">)</span></span>
<span><span class="va">spec</span> <span class="op">=</span> <span class="fu"><a href="../reference/beta_params.html">beta_params</a></span><span class="op">(</span>median <span class="op">=</span> <span class="fl">0.972</span>, lower<span class="op">=</span>  <span class="fl">0.927</span>, upper <span class="op">=</span> <span class="fl">0.998</span><span class="op">)</span></span>
<span></span>
<span><span class="va">sens</span></span>
<span><span class="co">#&gt; 74.6% [66.3%—81.9%] (N=118.1)</span></span>
<span><span class="va">spec</span></span>
<span><span class="co">#&gt; 97.4% [92.6%—99.5%] (N=87.4)</span></span></code></pre></div>
<p>For demonstration purposes we look at the true prevalence for every
value of apparent prevalence between 0 and 150 positives in an set of
1000 tests, using the 3 methods:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tmp1</span> <span class="op">=</span> <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>  observed <span class="op">=</span> <span class="fl">0</span><span class="op">:</span><span class="fl">150</span>,</span>
<span>  n <span class="op">=</span> <span class="fl">1000</span></span>
<span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span><span class="fu">testerror</span><span class="fu">::</span><span class="fu"><a href="../reference/true_prevalence.html">true_prevalence</a></span><span class="op">(</span></span>
<span>  pos_obs <span class="op">=</span> <span class="va">observed</span>,</span>
<span>  n_obs <span class="op">=</span> <span class="va">n</span>,</span>
<span>  sens <span class="op">=</span> <span class="va">sens</span>,</span>
<span>  spec <span class="op">=</span> <span class="va">spec</span>,</span>
<span>  method <span class="op">=</span> <span class="st">"bayes"</span>,</span>
<span>  model_type <span class="op">=</span> <span class="st">"logit"</span></span>
<span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">tmp2</span> <span class="op">=</span> <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>  observed <span class="op">=</span> <span class="fl">0</span><span class="op">:</span><span class="fl">150</span>,</span>
<span>  n <span class="op">=</span> <span class="fl">1000</span></span>
<span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span><span class="fu">testerror</span><span class="fu">::</span><span class="fu"><a href="../reference/true_prevalence.html">true_prevalence</a></span><span class="op">(</span></span>
<span>  pos_obs <span class="op">=</span> <span class="va">observed</span>,</span>
<span>  n_obs <span class="op">=</span> <span class="va">n</span>,</span>
<span>  sens <span class="op">=</span> <span class="va">sens</span>,</span>
<span>  spec <span class="op">=</span> <span class="va">spec</span>,</span>
<span>  method <span class="op">=</span> <span class="st">"lang"</span></span>
<span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">tmp3</span> <span class="op">=</span> <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>  observed <span class="op">=</span> <span class="fl">0</span><span class="op">:</span><span class="fl">150</span>,</span>
<span>  n <span class="op">=</span> <span class="fl">1000</span></span>
<span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span><span class="fu">testerror</span><span class="fu">::</span><span class="fu"><a href="../reference/true_prevalence.html">true_prevalence</a></span><span class="op">(</span></span>
<span>  pos_obs <span class="op">=</span> <span class="va">observed</span>,</span>
<span>  n_obs <span class="op">=</span> <span class="va">n</span>,</span>
<span>  sens <span class="op">=</span> <span class="va">sens</span>,</span>
<span>  spec <span class="op">=</span> <span class="va">spec</span>,</span>
<span>  method <span class="op">=</span> <span class="st">"rogan"</span></span>
<span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">tmp</span> <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="va">tmp1</span>,<span class="va">tmp2</span>,<span class="va">tmp3</span><span class="op">)</span></span></code></pre></div>
<p>Comparing the 3 methods for a wide range of apparent prevalence
qualitatively shows the different behaviour of the methods. The Bayesian
model seems more appropriate when prevalence is low as it does not
suffer from the same truncation issue as the other methods. It is
however much slower.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">thresh</span> <span class="op">=</span> <span class="fu">testerror</span><span class="fu">::</span><span class="fu"><a href="../reference/underestimation_threshold.html">underestimation_threshold</a></span><span class="op">(</span><span class="va">sens</span><span class="op">$</span><span class="fu">q</span><span class="op">(</span><span class="fl">0.5</span><span class="op">)</span>,<span class="va">spec</span><span class="op">$</span><span class="fu">q</span><span class="op">(</span><span class="fl">0.5</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">N</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">tmp</span><span class="op">$</span><span class="va">n</span><span class="op">)</span>  </span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">tmp</span>, <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y<span class="op">=</span><span class="va">observed</span><span class="op">/</span><span class="va">n</span>, x<span class="op">=</span><span class="va">prevalence.median</span>, xmin<span class="op">=</span><span class="va">prevalence.lower</span>, xmax<span class="op">=</span><span class="va">prevalence.upper</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_errorbarh.html" class="external-link">geom_errorbarh</a></span><span class="op">(</span>alpha<span class="op">=</span><span class="fl">0.4</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">tmp</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">observed</span><span class="op">==</span><span class="fl">40</span><span class="op">)</span>, colour<span class="op">=</span><span class="st">"orange"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_errorbarh.html" class="external-link">geom_errorbarh</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">tmp</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">observed</span><span class="op">==</span><span class="fl">40</span><span class="op">)</span>, colour<span class="op">=</span><span class="st">"orange"</span>, height<span class="op">=</span><span class="fl">0</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_abline</a></span><span class="op">(</span>colour<span class="op">=</span><span class="st">"blue"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">thresh</span>,y<span class="op">=</span><span class="va">thresh</span>,colour<span class="op">=</span><span class="st">"magenta"</span>, size<span class="op">=</span><span class="fl">4</span>, shape<span class="op">=</span><span class="fl">10</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_abline</a></span><span class="op">(</span>intercept <span class="op">=</span> <span class="fl">1</span><span class="op">-</span><span class="va">spec</span><span class="op">$</span><span class="fu">q</span><span class="op">(</span><span class="fl">0.5</span><span class="op">)</span>, slope <span class="op">=</span> <span class="va">sens</span><span class="op">$</span><span class="fu">q</span><span class="op">(</span><span class="fl">0.5</span><span class="op">)</span><span class="op">-</span><span class="op">(</span><span class="fl">1</span><span class="op">-</span><span class="va">spec</span><span class="op">$</span><span class="fu">q</span><span class="op">(</span><span class="fl">0.5</span><span class="op">)</span><span class="op">)</span>, colour<span class="op">=</span><span class="st">"red"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span>name<span class="op">=</span><span class="st">"observed apparent prevalence"</span>,sec.axis <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/sec_axis.html" class="external-link">sec_axis</a></span><span class="op">(</span>trans <span class="op">=</span> <span class="op">~</span> <span class="va">.x</span><span class="op">*</span><span class="va">N</span>,name <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"count (N=%d)"</span>,<span class="va">N</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>caption<span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"threshold value where true prevalence equals apparent prevalence: (%1.2f,%1.2f)\nspecificity: %s\nsensitivity: %s"</span>,<span class="va">thresh</span>,<span class="va">thresh</span>,<span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="va">spec</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="va">sens</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"estimated true prevalence"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">prevalence.method</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: The `trans` argument of `sec_axis()` is deprecated as of ggplot2 3.5.0.</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Please use the `transform` argument instead.</span></span>
<span><span class="co">#&gt; <span style="color: #555555;">This warning is displayed once every 8 hours.</span></span></span>
<span><span class="co">#&gt; <span style="color: #555555;">Call `lifecycle::last_lifecycle_warnings()` to see where this warning was</span></span></span>
<span><span class="co">#&gt; <span style="color: #555555;">generated.</span></span></span></code></pre></div>
<p><img src="single-test_files/figure-html/unnamed-chunk-9-1.png" width="576"></p>
<p>In the figure above the rogan-gladen adjustment for the median
sensitivity and specificity is the red line (base), the blue line shows
the case assuming the test is 100% sensitive and specific. and the
magenta cross the point at which true prevalence is equal to apparent
prevalence.</p>
</div>
<div class="section level2">
<h2 id="test-uncertainty">Test uncertainty<a class="anchor" aria-label="anchor" href="#test-uncertainty"></a>
</h2>
<p>In the example above we have no gold standard to compare output to.
For testing we can generate a simulation using the sensitivity and
specificity and using a range of simulated true prevalence. Applying
correction to simulated apparent prevalence allows us to compare to a
simulated gold standard. In this example the distribution of sensitivity
and specificity used to estimate the true prevalence is the same as that
used to simulate the “observed” data.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ex1</span> <span class="op">=</span> <span class="fu">testerror</span><span class="fu">:::</span><span class="fu">test_example</span><span class="op">(</span></span>
<span>  spec <span class="op">=</span> <span class="va">spec</span><span class="op">$</span><span class="va">shape1</span><span class="op">/</span><span class="va">spec</span><span class="op">$</span><span class="va">conc</span>,</span>
<span>  sens <span class="op">=</span> <span class="va">sens</span><span class="op">$</span><span class="va">shape1</span><span class="op">/</span><span class="va">sens</span><span class="op">$</span><span class="va">conc</span>,</span>
<span>  n_samples <span class="op">=</span> <span class="fl">5000</span>,</span>
<span>  n_controls <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">floor</a></span><span class="op">(</span><span class="va">spec</span><span class="op">$</span><span class="va">conc</span><span class="op">)</span>,</span>
<span>  n_diseased <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">floor</a></span><span class="op">(</span><span class="va">sens</span><span class="op">$</span><span class="va">conc</span><span class="op">)</span>,</span>
<span>  exact<span class="op">=</span><span class="cn">TRUE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">res1</span> <span class="op">=</span> <span class="va">ex1</span><span class="op">$</span><span class="va">summary</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span><span class="fu"><a href="../reference/true_prevalence.html">true_prevalence</a></span><span class="op">(</span></span>
<span>  pos_obs <span class="op">=</span> <span class="va">observed_pos</span>,</span>
<span>  n_obs <span class="op">=</span> <span class="va">n_samples</span>,</span>
<span>  false_pos_controls <span class="op">=</span> <span class="va">ex1</span><span class="op">$</span><span class="va">performance</span><span class="op">$</span><span class="va">false_pos_controls</span>,</span>
<span>  n_controls <span class="op">=</span> <span class="va">ex1</span><span class="op">$</span><span class="va">performance</span><span class="op">$</span><span class="va">n_controls</span>,</span>
<span>  false_neg_diseased <span class="op">=</span> <span class="va">ex1</span><span class="op">$</span><span class="va">performanc</span><span class="op">$</span><span class="va">false_neg_diseased</span>,</span>
<span>  n_diseased <span class="op">=</span> <span class="va">ex1</span><span class="op">$</span><span class="va">performance</span><span class="op">$</span><span class="va">n_diseased</span>,</span>
<span>  method <span class="op">=</span> <span class="st">"bayes"</span>,</span>
<span>  model_type <span class="op">=</span> <span class="st">"logit"</span></span>
<span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: There were 3 warnings in `dplyr::mutate()`.</span></span>
<span><span class="co">#&gt; The first warning was:</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> In argument: `true_prevalence(...)`.</span></span>
<span><span class="co">#&gt; Caused by warning:</span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00;">!</span> There were 22 divergent transitions after warmup. See</span></span>
<span><span class="co">#&gt; https://mc-stan.org/misc/warnings.html#divergent-transitions-after-warmup</span></span>
<span><span class="co">#&gt; to find out why this is a problem and how to eliminate them.</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Run `dplyr::last_dplyr_warnings()` to see the 2 remaining warnings.</span></span>
<span></span>
<span><span class="va">res2</span> <span class="op">=</span> <span class="va">ex1</span><span class="op">$</span><span class="va">summary</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span><span class="fu"><a href="../reference/true_prevalence.html">true_prevalence</a></span><span class="op">(</span></span>
<span>  pos_obs <span class="op">=</span> <span class="va">observed_pos</span>,</span>
<span>  n_obs <span class="op">=</span> <span class="va">n_samples</span>,</span>
<span>  false_pos_controls <span class="op">=</span> <span class="va">ex1</span><span class="op">$</span><span class="va">performance</span><span class="op">$</span><span class="va">false_pos_controls</span>,</span>
<span>  n_controls <span class="op">=</span> <span class="va">ex1</span><span class="op">$</span><span class="va">performance</span><span class="op">$</span><span class="va">n_controls</span>,</span>
<span>  false_neg_diseased <span class="op">=</span> <span class="va">ex1</span><span class="op">$</span><span class="va">performanc</span><span class="op">$</span><span class="va">false_neg_diseased</span>,</span>
<span>  n_diseased <span class="op">=</span> <span class="va">ex1</span><span class="op">$</span><span class="va">performance</span><span class="op">$</span><span class="va">n_diseased</span>,</span>
<span>  method <span class="op">=</span> <span class="st">"lang-reiczigel"</span></span>
<span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">res3</span> <span class="op">=</span> <span class="va">ex1</span><span class="op">$</span><span class="va">summary</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span><span class="fu"><a href="../reference/true_prevalence.html">true_prevalence</a></span><span class="op">(</span></span>
<span>  pos_obs <span class="op">=</span> <span class="va">observed_pos</span>,</span>
<span>  n_obs <span class="op">=</span> <span class="va">n_samples</span>,</span>
<span>  false_pos_controls <span class="op">=</span> <span class="va">ex1</span><span class="op">$</span><span class="va">performance</span><span class="op">$</span><span class="va">false_pos_controls</span>,</span>
<span>  n_controls <span class="op">=</span> <span class="va">ex1</span><span class="op">$</span><span class="va">performance</span><span class="op">$</span><span class="va">n_controls</span>,</span>
<span>  false_neg_diseased <span class="op">=</span> <span class="va">ex1</span><span class="op">$</span><span class="va">performanc</span><span class="op">$</span><span class="va">false_neg_diseased</span>,</span>
<span>  n_diseased <span class="op">=</span> <span class="va">ex1</span><span class="op">$</span><span class="va">performance</span><span class="op">$</span><span class="va">n_diseased</span>,</span>
<span>  method <span class="op">=</span> <span class="st">"rogan-gladen"</span></span>
<span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">testerror</span><span class="fu">:::</span><span class="fu">demo_bar_plot</span><span class="op">(</span><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="va">res1</span>,<span class="va">res2</span>,<span class="va">res3</span><span class="op">)</span>,.pcv <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>caption<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"Red lines / grey bars are apparent prevalence / counts</span></span>
<span><span class="st">Blue lines the underlying true prevalence rate.</span></span>
<span><span class="st">Test sensitivity: %s</span></span>
<span><span class="st">Test specificity: %s</span></span>
<span><span class="st">"</span>, <span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="va">sens</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="va">spec</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="single-test_files/figure-html/unnamed-chunk-10-1.png" width="576"></p>
<p>In the range of “true” prevalences tested here (0-20%) apparent
prevalence ranges from about 0.25 to 17.5%. Adjusting for test
uncertainty in the 3 methods described here gives a point estimate near
the true prevalence (blue line) in most cases. Confidence intervals are
a result of uncertainty in test performance metrics and not by
prevalence of disease. Not shown is the fact that the width of the
confidence of the correction is not improved by increasing the sample
size (although the accuracy of the central prediction is). Improving
confidence in our predictions of true prevalence can be achieved through
better estimates of test performance metrics.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Robert Challen.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
